name: "Deploy consumer notification"

on:
  push:
      branches:
        - master
#    tags:
#      - 'dev-v*'

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: yarn install

      - name: Log in to docker hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}

      - name: Get version from git tags
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0)
          if [[ -z "$VERSION" ]]; then
            VERSION="v0.1.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Docker
        run: |
          docker build --platform linux/amd64 -t joaojunior1205/notification-consumer:$VERSION .

      - name: Push Docker image with tag and latest
        run: |
          docker push joaojunior1205/bf-dev:$VERSION
          docker push joaojunior1205/bf-dev:latest

      - name: Commit and push version update
        run: |
          git config --global user.email "your-email@example.com"
          git config --global user.name "Your Name"
          git add version.txt
          git tag $VERSION
          git push --tags